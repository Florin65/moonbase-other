# Bail if we're not running a core with kernel fuctions

if [ ! -e $FUNCTIONS/kernel.lunar ] ; then
  message "${PROBLEM_COLOR}Bailing out, ${DEFAULT_COLOR}Lunar (or theedge) code version too old"
  message "${PROBLEM_COLOR}Update core ${MODULE_COLOR}(lin lunar or lin theedge)${DEFAULT_COLOR} to install this kernel"
  exit 1
fi

if [ -e /usr/src/linux -a ! -h /usr/src/linux ]; then
  message "${PROBLEM_COLOR}Error:${DEFAULT_COLOR} /usr/src/linux must be a symbolic link"
  exit 1
fi

mk_source_dir $SOURCE_DIRECTORY
rm -f /usr/src/linux
ln -s $SOURCE_DIRECTORY /usr/src/linux
cd $SOURCE_DIRECTORY

# Yes, this is a workaround. Blame tar. Or sofar.

if ! [ `lvu installed tar` == 1.15.1 ]; then
  tar jxf $SOURCE_CACHE/$SOURCE --no-same-owner --no-same-permissions --strip-path=1
else
  tar xf $SOURCE_CACHE/$SOURCE --no-same-owner --no-same-permissions --strip-components=1
fi

if [ -f $CONFIG_CACHE/.config.grsec ]; then
  cp $CONFIG_CACHE/.config.grsec .config
fi

mkdir patches
( cd patches && unpack $SOURCE2 )
for pat in patches/fix/* patches/main/* patches/grsecurity/*;  do
  patch_it $pat 1
done
rm -rf patches

true
