cd /usr/src

if [ ! -d linux-${VERSION} ]; then
    
    rm  -rf  linux-${KERNEL_VERSION} # we remove this one just in case
    rm  -rf  linux-${VERSION}
    rm  -rf  linux

    unpack  $SOURCE

    # the main kernel tarball unpacks with 2.6.X name, not with the -mm added
    # so, f.e.: linux-2.6.X will be renamed as linux-2.6.X-mmY

    test -n "${KERNEL_VERSION}" && test "${KERNEL_VERSION}" != "${VERSION}" && mv linux-${KERNEL_VERSION} linux-${VERSION}

    ln  -sf  linux-${VERSION}  linux

    chown  root.root  /usr/src/linux
    chown  -R  root.root  /usr/src/linux-${VERSION}

    cd  linux/

    patch_it  $SOURCE2  1

	for config in .config-2.6-prepatch .config.beta
	do
		test  -f  ${CONFIG_CACHE}/${config}  || continue
		cp        ${CONFIG_CACHE}/${config}  /usr/src/linux/.config
		break 
	done

else

    message "Sources found: /usr/src/linux-${VERSION}"
        
    if [ "`readlink linux`" != "linux-${VERSION}" ]; then
	rm -rf linux
	ln -s linux-${VERSION} linux
    fi
			    
fi
